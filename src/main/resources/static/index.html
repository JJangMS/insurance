<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸš— Insurance Core | Portfolio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .step { display: none; transition: all 0.3s ease; }
        .step.active { display: block; }
        .progress-bar { transition: width 0.5s ease-in-out; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen flex items-center justify-center font-sans">

<div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-lg border border-slate-100">
    <div class="w-full bg-slate-200 h-1.5 rounded-full mb-8">
        <div id="progressBar" class="bg-orange-400 h-1.5 rounded-full progress-bar" style="width: 25%"></div>
    </div>

    <header class="text-center mb-8">
        <h1 class="text-3xl font-extrabold text-orange-400">Auto Insurance</h1>
        <p class="text-slate-500 mt-2">[ìë™ì°¨ ë³´í—˜ ë°ëª¨] ì¥ë¯¼ìˆ˜ì…ë‹ˆë‹¤. ì˜ ë¶€íƒë“œë¦½ë‹ˆë‹¤.</p>
    </header>

    <div id="step1" class="step active">
        <div class="space-y-5">
            <div>
                <label class="block text-sm font-medium text-orange-400 mb-1">ì„±í•¨</label>
                <input type="text"
                       id="name"
                       value="ì¥ë¯¼ìˆ˜"
                       class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-orange-500 outline-none">
            </div>
            <div>
                <label class="block text-sm font-medium text-orange-400 mb-1">ìƒë…„ì›”ì¼</label>
                <input type="date" id="birthDate" value="1993-02-12" class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-orange-500 outline-none">
            </div>
            <div>
                <label class="block text-sm font-medium text-orange-400 mb-1">íœ´ëŒ€í°ë²ˆí˜¸</label>
                <input type="text" id="phone" value="010-1234-5678" class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-orange-500 outline-none">
            </div>
            <button onclick="inquire()" class="w-full bg-orange-400 text-white py-4 rounded-xl font-bold hover:bg-orange-600 transition">ë‹¤ìŒ</button>
        </div>
    </div>

    <div id="step-2-1" class="step">
        <div class="mb-6 bg-orange-50 p-4 rounded-xl border border-orange-100">
            <p class="text-orange-700 text-sm font-bold">ì´ì „ì— ê°€ì…í–ˆë˜ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            <p class="text-orange-600 text-xs mt-1">ì°¨ëŸ‰ ì •ë³´ë¥¼ ì…ë ¥í•˜ì—¬ ë°”ë¡œ ë³´í—˜ë£Œë¥¼ í™•ì¸í•´ë³´ì„¸ìš”!</p>
        </div>

        <div class="space-y-5">
            <div>
                <label class="block text-sm font-medium text-orange-400 mb-1">ì°¨ëŸ‰ ë²ˆí˜¸</label>
                <input type="text" id="newCarNumber" placeholder="123ê°€4567" class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-orange-500 outline-none">
            </div>
            <div>
                <label class="block text-sm font-medium text-orange-400 mb-1">ì°¨ì¢… (ëª¨ë¸ëª…)</label>
                <input type="text" id="newCarModel" placeholder="ëª¨ë¸y" class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-orange-500 outline-none">
            </div>
            <div>
                <label class="block text-sm font-medium text-orange-400 mb-1">ì„¸ë¶€ ëª¨ë¸ëª…</label>
                <input type="text" id="newCarModelName" placeholder="ë“€ì–¼ëª¨í„°" class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-orange-500 outline-none">
            </div>
            <div>
                <label class="block text-sm font-medium text-orange-400 mb-1">ì—°ì‹</label>
                <input type="number" id="newCarYear" value="2026" class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-orange-500 outline-none">
            </div>

            <button onclick="registerNewUser()" class="w-full bg-orange-400 text-white py-4 rounded-xl font-bold hover:bg-orange-600 transition">ë‹¤ìŒ</button>
        </div>
    </div>

    <div id="step2" class="step">
        <div class="bg-slate-50 p-6 rounded-2xl border border-slate-100 mb-6">
            <h3 class="font-bold text-slate-800 mb-4 flex items-center">ğŸ“ ê³ ê° ë° ì°¨ëŸ‰ ì •ë³´</h3>
            <div class="space-y-3 text-sm text-slate-600">
                <div class="flex justify-between border-b pb-2"><span>ìš´ì „ì</span> <span id="displayDriver" class="font-bold text-orange-400"></span></div>
                <div class="flex justify-between border-b pb-2"><span>ì°¨ëŸ‰ë²ˆí˜¸</span> <span id="displayCarNum" class="font-bold text-orange-400"></span></div>
                <div class="flex justify-between"><span>ëª¨ë¸ëª…</span> <span id="displayCarModel" class="font-bold text-orange-400"></span></div>
            </div>
        </div>
        <button onclick="create()" class="w-full bg-orange-400 text-white py-4 rounded-xl font-bold hover:bg-orange-600 transition">ë³´í—˜ë£Œ ì‚°ì¶œí•˜ê¸°</button>
    </div>

    <div id="step3" class="step">
        <div class="text-center mb-8">
            <p class="text-slate-500 mb-1 font-medium text-sm">ì‚°ì¶œëœ ì—°ê°„ ë³´í—˜ë£Œ</p>
            <p class="text-5xl font-black text-orange-500" id="displayPremium">0ì›</p>
        </div>
        <div class="mb-6">
            <label class="block text-sm font-medium text-slate-700 mb-2">ë³´í—˜ íš¨ë ¥ ë°œìƒì¼</label>
            <input type="date" id="startDate" class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-orange-500 outline-none">
        </div>
        <button onclick="approve()" class="w-full bg-orange-400 text-white py-4 rounded-xl font-bold hover:bg-orange-600 transition">ê°€ì… í™•ì •í•˜ê¸°</button>
    </div>

    <div id="step4" class="step text-center py-4">
        <div class="inline-flex items-center justify-center w-20 h-20 bg-green-100 text-green-600 rounded-full text-4xl mb-6">âœ“</div>
        <h2 class="text-2xl font-bold text-orange-400 mb-2">ë³´í—˜ ê°€ì… ì„±ê³µ!</h2>
        <p class="text-slate-900 mb-6 leading-relaxed">ì¶•í•˜ë“œë¦½ë‹ˆë‹¤. ì •ìƒì ìœ¼ë¡œ ì‹¬ì‚¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.<br>ì¦ê¶Œë²ˆí˜¸: <span id="finalPolicyNum" class="font-mono font-bold text-slate-900"></span></p>
        <button onclick="location.reload()" class="w-full bg-orange-400 text-white py-4 rounded-xl font-bold hover:bg-orange-600 transition">í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
    </div>
</div>

<script>
    // ì „í™”ë²ˆí˜¸ ìë¥´ê¸°
    document.getElementById('phone').addEventListener('input', function (e) {
        let value = e.target.value.replace(/[^0-9]/g, '');
        let result = '';

        if (value.length <= 3) {
            result = value;
        } else if (value.length <= 7) {
            result = value.substr(0, 3) + '-' + value.substr(3);
        } else {
            result = value.substr(0, 3) + '-' + value.substr(3, 4) + '-' + value.substr(7, 4);
        }

        e.target.value = result;
    });

    // ë³´í—˜ ì‹œì‘ì¼
    document.addEventListener('DOMContentLoaded', function() {
        const startDateInput = document.getElementById('startDate');

        const today = new Date();

        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');

        const formattedDate = `${year}-${month}-${day}`;

        startDateInput.value = formattedDate;
        startDateInput.min = formattedDate;
    });

    // ì„œë²„ í†µì‹ 
    let driverId, carId, policyId;
    const BASE_URL = '/api/v1';

    function showStep(num) {
        document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
        document.getElementById('step' + num).classList.add('active');

        let progress = 0;
        if (num === '-2-1') {
            progress = 35;
        } else {
            progress = num * 25;
        }
        document.getElementById('progressBar').style.width = progress + '%';
    }

    async function inquire() {
        const name = document.getElementById('name').value;
        const birthDate = document.getElementById('birthDate').value;
        const phone = document.getElementById('phone').value;

        try {
            const res = await fetch(`${BASE_URL}/driver/inquiry?name=${name}&birthDate=${birthDate}&phone=${phone}`);

            if (res.status === 200) {
                const data = await res.json().catch(() => null);
                console.log("JJ::inquire::", data);

                if (data) {
                    driverId = data.driverId;
                    carId = data.carId;
                    document.getElementById('displayDriver').innerText = data.name;
                    document.getElementById('displayCarNum').innerText = data.carNumber;
                    document.getElementById('displayCarModel').innerText = data.carModel;
                    showStep(2);
                } else {
                    showStep('-2-1');
                }
            } else {
                showStep('-2-1');
            }
        } catch (e) {
            console.error(e);
            alert("ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\nì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
        }
    }

    async function create() {
        try {
            const res = await fetch(`${BASE_URL}/policy/create`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ driverId, carId })
            });

            if (res.ok) {
                const data = await res.json();
                console.log("JJ::create::", data);

                policyId = data.id;
                const premiumValue = data.premium || 0;

                document.getElementById('displayPremium').innerText = premiumValue.toLocaleString() + 'ì›';
                showStep(3);
            } else {
                const errorData = await res.json();
                alert(errorData.message || "\nì‹¬ì‚¬ ê¸°ì¤€ì— ë¯¸ë‹¬í•˜ì—¬ ê°€ì…ì´ ê±°ì ˆë˜ì—ˆìŠµë‹ˆë‹¤.");
                location.reload();
            }
        } catch (e) {
            console.error("ì—ëŸ¬ ë°œìƒ:", e);
            alert("ë³´í—˜ë£Œ ì‚°ì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    }

    async function approve() {
        const startDate = document.getElementById('startDate').value;
        if (!startDate) return alert("ì‹œì‘ì¼ì„ ì„ íƒí•˜ì„¸ìš”.");
        const res = await fetch(`${BASE_URL}/policy/${policyId}/approve`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ startDate })
        });

        const data = await res.json();
        console.log("JJ::approve::", data);

        if (data.status === 'APPROVED') {
            document.getElementById('finalPolicyNum').innerText = data.policyNumber;
            showStep(4);
        } else {
            alert("ê°€ì…ì´ ê±°ì ˆë˜ì—ˆìŠµë‹ˆë‹¤.");
            alert(errorData.message);
        }
    }

    async function registerNewUser() {
        const reqBody = {
            // Step 1
            name: document.getElementById('name').value,
            birthDate: document.getElementById('birthDate').value,
            phone: document.getElementById('phone').value,

            // Step 2-1
            carNumber: document.getElementById('newCarNumber').value,
            carModel: document.getElementById('newCarModel').value,
            carModelName: document.getElementById('newCarModelName').value,
            carModelYear: parseInt(document.getElementById('newCarYear').value) || 2024
        };

        if (!reqBody.carNumber || !reqBody.carModel) {
            return alert("ì°¨ëŸ‰ ë²ˆí˜¸ì™€ ì°¨ì¢…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        }

        try {
            const res = await fetch(`${BASE_URL}/driver/register`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(reqBody)
            });

            if (res.status === 200) {
                const data = await res.json();
                console.log("JJ::registerNewUser::", data);

                driverId = data.driverId;
                carId = data.carId;
                document.getElementById('displayDriver').innerText = data.name;
                document.getElementById('displayCarNum').innerText = data.carNumber;
                document.getElementById('displayCarModel').innerText = data.carModel;
                alert("ì°¨ëŸ‰ ë“±ë¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
                showStep(2);
            } else {
                alert("ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì…ë ¥ ì •ë³´ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
            }
        } catch (e) {
            console.error("ë“±ë¡ ì—ëŸ¬:", e);
            alert("ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\nì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
        }
    }
</script>
</body>
</html>
